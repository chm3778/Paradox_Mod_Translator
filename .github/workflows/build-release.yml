name: ðŸš€ Build and Release

on:
  push:
    tags:
      - 'v*'  # è§¦å‘æ¡ä»¶ï¼šæŽ¨é€ç‰ˆæœ¬æ ‡ç­¾ (å¦‚ v1.0.0)
  workflow_dispatch:  # å…è®¸æ‰‹åŠ¨è§¦å‘
    inputs:
      version:
        description: 'Release version (e.g., v1.0.0)'
        required: true
        default: 'v1.0.0'

jobs:
  build:
    name: Build on ${{ matrix.os }}
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        include:
          - os: windows-latest
            artifact_name: Paradox-Mod-Translator-Windows
            asset_name: Paradox-Mod-Translator-Windows.zip
          - os: ubuntu-latest
            artifact_name: Paradox-Mod-Translator-Linux
            asset_name: Paradox-Mod-Translator-Linux.tar.gz
          - os: macos-latest
            artifact_name: Paradox-Mod-Translator-macOS
            asset_name: Paradox-Mod-Translator-macOS.zip

    steps:
    - name: ðŸ“¥ Checkout code
      uses: actions/checkout@v4

    - name: ðŸ Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'  # ä½¿ç”¨ç¨³å®šçš„Pythonç‰ˆæœ¬

    - name: ðŸ“¦ Install system dependencies (Linux)
      if: matrix.os == 'ubuntu-latest'
      run: |
        sudo apt-get update
        sudo apt-get install -y python3-tk

    - name: ðŸ“¦ Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install --timeout=300 -r requirements-ci.txt

    - name: ðŸ” Test imports
      run: |
        python test_imports.py
      env:
        PYTHONIOENCODING: utf-8

    - name: ðŸ§ª Run tests
      run: |
        python run_tests.py
      env:
        PYTHONIOENCODING: utf-8

    - name: ðŸ”§ Build with PyInstaller (Windows)
      if: matrix.os == 'windows-latest'
      run: |
        echo "Starting PyInstaller build for Windows..."
        pyinstaller --clean --noconfirm --onedir --windowed --name ParadoxModTranslator ^
          --hidden-import=google.generativeai ^
          --hidden-import=ttkbootstrap ^
          --hidden-import=tkinter ^
          --hidden-import=tkinter.ttk ^
          --hidden-import=tkinter.filedialog ^
          --hidden-import=tkinter.messagebox ^
          --hidden-import=tkinter.scrolledtext ^
          --hidden-import=tkinter.simpledialog ^
          --hidden-import=config.constants ^
          --hidden-import=config.config_manager ^
          --hidden-import=parsers.yml_parser ^
          --hidden-import=core.api_key_manager ^
          --hidden-import=core.parallel_translator ^
          --hidden-import=utils.logging_utils ^
          main_refactored.py
        echo "PyInstaller build completed"

    - name: ðŸ”§ Build with PyInstaller (Linux)
      if: matrix.os == 'ubuntu-latest'
      run: |
        echo "Starting PyInstaller build for Linux..."
        pyinstaller --clean --noconfirm --onedir --windowed --name ParadoxModTranslator \
          --hidden-import=google.generativeai \
          --hidden-import=ttkbootstrap \
          --hidden-import=tkinter \
          --hidden-import=tkinter.ttk \
          --hidden-import=tkinter.filedialog \
          --hidden-import=tkinter.messagebox \
          --hidden-import=tkinter.scrolledtext \
          --hidden-import=tkinter.simpledialog \
          --hidden-import=config.constants \
          --hidden-import=config.config_manager \
          --hidden-import=parsers.yml_parser \
          --hidden-import=core.api_key_manager \
          --hidden-import=core.parallel_translator \
          --hidden-import=utils.logging_utils \
          main_refactored.py
        echo "PyInstaller build completed"

    - name: ðŸ”§ Build with PyInstaller (macOS)
      if: matrix.os == 'macos-latest'
      run: |
        echo "Starting PyInstaller build for macOS..."
        pyinstaller --clean --noconfirm --onedir --windowed --name ParadoxModTranslator \
          --hidden-import=google.generativeai \
          --hidden-import=ttkbootstrap \
          --hidden-import=tkinter \
          --hidden-import=tkinter.ttk \
          --hidden-import=tkinter.filedialog \
          --hidden-import=tkinter.messagebox \
          --hidden-import=tkinter.scrolledtext \
          --hidden-import=tkinter.simpledialog \
          --hidden-import=config.constants \
          --hidden-import=config.config_manager \
          --hidden-import=parsers.yml_parser \
          --hidden-import=core.api_key_manager \
          --hidden-import=core.parallel_translator \
          --hidden-import=utils.logging_utils \
          main_refactored.py
        echo "PyInstaller build completed"

    - name: ðŸ” Debug build output
      run: |
        echo "=== Listing dist directory ==="
        ls -la dist/ || echo "dist directory not found"
        echo "=== Listing dist contents recursively ==="
        find dist/ -type f 2>/dev/null || echo "No files found in dist"

    - name: ðŸ“ Prepare artifacts (Windows)
      if: matrix.os == 'windows-latest'
      shell: bash
      run: |
        mkdir release
        if [ -d "dist/ParadoxModTranslator" ]; then
          cp -r dist/ParadoxModTranslator/* release/
        else
          echo "Warning: dist/ParadoxModTranslator not found, copying dist contents"
          cp -r dist/* release/
        fi
        cp README.md release/ || echo "README.md not found"
        cp CONFIGURATION_GUIDE.md release/ || echo "CONFIGURATION_GUIDE.md not found"
        echo "Build completed on $(date)" > release/BUILD_INFO.txt

    - name: ðŸ“ Prepare artifacts (Linux/macOS)
      if: matrix.os != 'windows-latest'
      run: |
        mkdir release
        if [ -d "dist/ParadoxModTranslator" ]; then
          cp -r dist/ParadoxModTranslator/* release/
        else
          echo "Warning: dist/ParadoxModTranslator not found, copying dist contents"
          cp -r dist/* release/
        fi
        cp README.md release/ || echo "README.md not found"
        cp CONFIGURATION_GUIDE.md release/ || echo "CONFIGURATION_GUIDE.md not found"
        echo "Build completed on $(date)" > release/BUILD_INFO.txt

    - name: ðŸ—œï¸ Create archive (Windows)
      if: matrix.os == 'windows-latest'
      shell: powershell
      run: |
        cd release
        Compress-Archive -Path * -DestinationPath ../${{ matrix.asset_name }}

    - name: ðŸ—œï¸ Create archive (macOS)
      if: matrix.os == 'macos-latest'
      run: |
        cd release
        zip -r ../${{ matrix.asset_name }} *

    - name: ðŸ—œï¸ Create archive (Linux)
      if: matrix.os == 'ubuntu-latest'
      run: |
        cd release
        tar -czf ../${{ matrix.asset_name }} *

    - name: ðŸ“¤ Upload artifacts
      uses: actions/upload-artifact@v4
      with:
        name: ${{ matrix.artifact_name }}
        path: ${{ matrix.asset_name }}

  release:
    name: ðŸŽ‰ Create Release
    needs: build
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/') || github.event_name == 'workflow_dispatch'

    steps:
    - name: ðŸ“¥ Checkout code
      uses: actions/checkout@v4

    - name: ðŸ“¥ Download all artifacts
      uses: actions/download-artifact@v4

    - name: ðŸ·ï¸ Get version
      id: get_version
      run: |
        if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
          echo "VERSION=${{ github.event.inputs.version }}" >> $GITHUB_OUTPUT
        else
          echo "VERSION=${GITHUB_REF#refs/tags/}" >> $GITHUB_OUTPUT
        fi

    - name: ðŸ“ Generate release notes
      id: release_notes
      run: |
        cat > release_notes.md << 'EOF'
        # ðŸŽ® Paradox Mod Translator ${{ steps.get_version.outputs.VERSION }}
        
        ## âœ¨ æ–°åŠŸèƒ½
        - å®Œæ•´çš„æ¨¡å—åŒ–æž¶æž„é‡æž„
        - å›¾å½¢åŒ–ç¿»è¯‘é…ç½®ç•Œé¢
        - å¤šAPIå¯†é’¥ç®¡ç†å’Œè´Ÿè½½å‡è¡¡
        - æ™ºèƒ½å¯åŠ¨å™¨å’Œä¾èµ–æ£€æŸ¥
        - å…¨é¢çš„æµ‹è¯•æ¡†æž¶
        
        ## ðŸ—ï¸ æž¶æž„æ”¹è¿›
        - å•ä¸€èŒè´£åŽŸåˆ™åº”ç”¨
        - è®¾è®¡æ¨¡å¼å®žçŽ°ï¼ˆå•ä¾‹ã€å·¥åŽ‚ã€ç­–ç•¥ã€è§‚å¯Ÿè€…ï¼‰
        - ç±»åž‹æç¤ºå’Œè¯¦ç»†æ–‡æ¡£
        - å¼ºå¤§çš„é”™è¯¯å¤„ç†å’Œè¾“å…¥éªŒè¯
        
        ## ðŸ“¦ ä¸‹è½½è¯´æ˜Ž
        
        ### Windows ç”¨æˆ·
        ä¸‹è½½ `Paradox-Mod-Translator-Windows.zip`ï¼Œè§£åŽ‹åŽè¿è¡Œ `ParadoxModTranslator.exe`
        
        ### Linux ç”¨æˆ·
        ä¸‹è½½ `Paradox-Mod-Translator-Linux.tar.gz`ï¼Œè§£åŽ‹åŽè¿è¡Œ `./ParadoxModTranslator`
        
        ### macOS ç”¨æˆ·
        ä¸‹è½½ `Paradox-Mod-Translator-macOS.zip`ï¼Œè§£åŽ‹åŽè¿è¡Œ `ParadoxModTranslator`
        
        ## ðŸ”§ ç³»ç»Ÿè¦æ±‚
        - æ— éœ€å®‰è£…PythonçŽ¯å¢ƒ
        - éœ€è¦ç½‘ç»œè¿žæŽ¥è®¿é—®Google Gemini API
        - å»ºè®®4GBä»¥ä¸Šå†…å­˜
        
        ## ðŸ“š ä½¿ç”¨æŒ‡å—
        è¯·å‚è€ƒåŒ…å«çš„ `README.md` å’Œ `CONFIGURATION_GUIDE.md` æ–‡ä»¶
        
        ## ðŸ› é—®é¢˜åé¦ˆ
        å¦‚é‡åˆ°é—®é¢˜ï¼Œè¯·åœ¨ [GitHub Issues](https://github.com/chm3778/Paradox_Mod_Translator/issues) ä¸­åé¦ˆ
        EOF

    - name: ðŸŽ‰ Create Release
      uses: softprops/action-gh-release@v1
      with:
        tag_name: ${{ steps.get_version.outputs.VERSION }}
        name: Paradox Mod Translator ${{ steps.get_version.outputs.VERSION }}
        body_path: release_notes.md
        draft: false
        prerelease: false
        files: |
          Paradox-Mod-Translator-Windows/Paradox-Mod-Translator-Windows.zip
          Paradox-Mod-Translator-Linux/Paradox-Mod-Translator-Linux.tar.gz
          Paradox-Mod-Translator-macOS/Paradox-Mod-Translator-macOS.zip
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
